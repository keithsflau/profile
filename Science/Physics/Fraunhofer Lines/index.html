<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fraunhofer Lines Laboratory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; overflow-x: hidden; }
        
        /* Star Background */
        .star-field {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0;
            background-image: 
                radial-gradient(white, rgba(255,255,255,.2) 2px, transparent 3px),
                radial-gradient(white, rgba(255,255,255,.1) 1px, transparent 2px);
            background-size: 550px 550px, 350px 350px;
            animation: star-move 200s linear infinite;
        }
        @keyframes star-move { from { transform: translateY(0); } to { transform: translateY(-550px); } }

        /* Spectrum Gradient */
        .spectrum-gradient {
            background: linear-gradient(to right, #4b0082, #0000ff, #00ff00, #ffff00, #ff7f00, #ff0000);
        }
        
        /* Interactive Lines */
        .emission-line { box-shadow: 0 0 5px currentColor; transition: all 0.2s; }
        .emission-line:hover { height: 140% !important; top: -20% !important; z-index: 50; box-shadow: 0 0 15px currentColor; }
        
        /* Animations */
        @keyframes pulse-glow { 0%, 100% { transform: scale(1); opacity: 0.9; } 50% { transform: scale(1.05); opacity: 1; } }
        .star-core { animation: pulse-glow 3s infinite ease-in-out; }

        @keyframes scan { 0% { top: 0%; opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { top: 100%; opacity: 0; } }
        .scan-line { animation: scan 1.5s ease-in-out infinite; }
        
        .click-tooltip { animation: pop-in 0.2s forwards; }
        @keyframes pop-in { from { transform: translate(-50%, 10px) scale(0.8); opacity: 0; } to { transform: translate(-50%, 0) scale(1); opacity: 1; } }
    </style>
</head>
<body class="text-slate-200 min-h-screen flex flex-col relative">

    <div class="star-field"></div>

    <nav class="bg-slate-900/90 backdrop-blur border-b border-slate-700 p-4 sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold text-white tracking-wide flex items-center gap-2">
                <div class="w-6 h-6 bg-yellow-500 rounded-full shadow-[0_0_10px_orange]"></div> Fraunhofer Lab
            </h1>
            <button onclick="toggleModal()" class="text-sm bg-slate-800 hover:bg-slate-700 border border-slate-600 px-3 py-1 rounded transition">How it works</button>
        </div>
    </nav>

    <main class="flex-grow container mx-auto p-4 space-y-6 relative z-10">

        <section class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-slate-800/80 backdrop-blur rounded-xl p-6 border border-slate-700 flex flex-col justify-center">
                <label class="text-xs font-bold text-blue-400 uppercase tracking-wider mb-2">Target Star</label>
                <select id="starSelector" onchange="changeStar()" class="w-full bg-slate-900 border border-slate-600 text-white py-2 px-3 rounded focus:outline-none focus:border-blue-500 cursor-pointer">
                    <option value="sun">The Sun (Type G - Balanced)</option>
                    <option value="vega">Vega (Type A - Hot/Blue)</option>
                    <option value="betelgeuse">Betelgeuse (Type M - Cool/Red)</option>
                </select>
                <p class="text-xs text-slate-500 mt-2 italic" id="starDescription">Balanced spectrum. Visible Iron, Sodium, and Hydrogen.</p>
            </div>

            <div class="bg-slate-800/80 backdrop-blur rounded-xl p-6 border border-slate-700 md:col-span-2 flex items-center justify-center relative overflow-hidden">
                <div class="flex items-center gap-8">
                    <div class="relative">
                        <div id="starVisual" class="w-20 h-20 rounded-full bg-yellow-400 shadow-[0_0_50px_orange] star-core transition-colors duration-1000"></div>
                        <div class="absolute -inset-4 border border-dashed border-slate-500 rounded-full animate-[spin_20s_linear_infinite] opacity-30"></div>
                    </div>
                    <div class="h-1 w-24 bg-gradient-to-r from-white/50 to-transparent"></div>
                    <div class="w-12 h-12 bg-blue-600 rounded-full border-2 border-slate-400 shadow-[0_0_20px_blue] relative">
                         <div class="absolute inset-0 bg-[url('https://upload.wikimedia.org/wikipedia/commons/thumb/9/97/The_Earth_seen_from_Apollo_17.jpg/240px-The_Earth_seen_from_Apollo_17.jpg')] bg-cover opacity-80 rounded-full"></div>
                    </div>
                </div>
                <div class="absolute bottom-2 right-4 text-xs text-slate-500">Light travels from Star → Earth</div>
            </div>
        </section>

        <section class="bg-slate-800/90 backdrop-blur rounded-xl p-6 border border-slate-700 relative">
            
            <div class="flex justify-between items-end mb-6">
                <h2 class="text-lg font-bold text-white">Spectral Analysis</h2>
                <label class="flex items-center gap-2 cursor-pointer bg-slate-900 px-3 py-1.5 rounded border border-slate-600 hover:border-blue-500 transition">
                    <span class="text-sm text-slate-300">Show Correlations</span>
                    <input type="checkbox" id="matchToggle" class="accent-blue-500 w-4 h-4" onchange="toggleMatchLines()">
                </label>
            </div>

            <div class="relative space-y-8 pb-4" id="mainSpectrumContainer">
                
                <canvas id="connectionCanvas" class="absolute top-0 left-0 w-full h-full pointer-events-none z-50 opacity-0 transition-opacity duration-300"></canvas>

                <!-- Top Spectrum (Observation) -->
                <div class="relative group">
                    <div class="flex justify-between text-xs text-slate-500 mb-1 font-mono"><span>400nm</span><span class="font-bold text-white">Star Light (Absorption)</span><span>700nm</span></div>
                    <div class="h-20 w-full rounded bg-slate-900 relative shadow-lg overflow-hidden border border-slate-600">
                        <div class="h-full w-full spectrum-gradient relative z-10" id="solarSpectrum"></div>
                    </div>
                </div>

                <!-- Bottom Spectrums (Reference) - FIXED: Removed pl-4 and border-l to ensure exact width match -->
                <div class="space-y-4">
                    
                    <div class="relative">
                        <div class="flex justify-between text-xs text-slate-400 mb-1"><span class="font-bold text-blue-400">Hydrogen (H)</span></div>
                        <div class="h-10 w-full bg-black rounded border border-slate-600 relative" id="hydrogenSpectrum"></div>
                    </div>

                    <div class="relative">
                        <div class="flex justify-between text-xs text-slate-400 mb-1"><span class="font-bold text-green-400">Helium (He)</span></div>
                        <div class="h-10 w-full bg-black rounded border border-slate-600 relative" id="heliumSpectrum"></div>
                    </div>

                    <div class="relative">
                        <div class="flex justify-between text-xs text-slate-400 mb-1"><span class="font-bold text-yellow-400">Sodium (Na)</span></div>
                        <div class="h-10 w-full bg-black rounded border border-slate-600 relative" id="sodiumSpectrum"></div>
                    </div>

                    <div class="relative">
                        <div class="flex justify-between text-xs text-slate-400 mb-1"><span class="font-bold text-purple-400">Iron (Fe) & Magnesium (Mg)</span></div>
                        <div class="h-10 w-full bg-black rounded border border-slate-600 relative" id="metalSpectrum"></div>
                    </div>
                </div>
            </div>
            
            <p class="mt-6 text-xs text-center text-slate-500">
                Tip: Click on any colored line to see its wavelength. Switch stars to see how absorption patterns change.
            </p>
        </section>

    </main>

    <div id="infoModal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="toggleModal()"></div>
        <div class="relative bg-slate-800 rounded-xl p-6 max-w-lg w-full border border-slate-600 shadow-2xl">
            <h3 class="text-xl font-bold text-white mb-4">Understanding the Lines</h3>
            <p class="text-slate-300 text-sm mb-4">When starlight passes through the star's cooler atmosphere, specific elements absorb specific colors of light. This creates dark gaps (Absorption Lines).</p>
            <p class="text-slate-300 text-sm mb-4">By matching these dark gaps to the bright lines (Emission Lines) produced by elements on Earth, we can determine exactly what a star is made of!</p>
            <button onclick="toggleModal()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 rounded transition">Close</button>
        </div>
    </div>

    <script>
        const MIN_WL = 400, MAX_WL = 700;

        // --- Data ---
        const spectralData = [
            // Hydrogen Series (Balmer)
            { label: 'h', wl: 410, el: 'H (Delta)', color: '#7a26c9', type: 'H' },   
            { label: 'g', wl: 434, el: 'H (Gamma)', color: '#0000ff', type: 'H' },   
            { label: 'F', wl: 486, el: 'H (Beta)',  color: '#00ffff', type: 'H' },   
            { label: 'C', wl: 656, el: 'H (Alpha)', color: '#ff0000', type: 'H' },   
            
            // Helium
            { label: 'He1', wl: 447.1, el: 'He', color: '#0033ff', type: 'He' }, 
            { label: 'He2', wl: 501.6, el: 'He', color: '#00ff99', type: 'He' }, 
            { label: 'D3',  wl: 587.6, el: 'He', color: '#ffff00', type: 'He' }, 
            { label: 'He3', wl: 667.8, el: 'He', color: '#ff2200', type: 'He' }, 
            { label: 'He4', wl: 706.5, el: 'He', color: '#990000', type: 'He' },

            // Sodium (The famous Doublet)
            { label: 'D2', wl: 589.0, el: 'Na', color: '#ffcc00', type: 'Na' }, 
            { label: 'D1', wl: 589.6, el: 'Na', color: '#ffcc00', type: 'Na' }, 

            // Metals (Fe, Mg, Ca)
            { label: 'G',  wl: 430, el: 'Fe/Ca', color: '#4b0082', type: 'Metal' }, 
            { label: 'b1', wl: 517, el: 'Mg',    color: '#00ff00', type: 'Metal' }, 
            { label: 'b2', wl: 518, el: 'Mg',    color: '#00ff00', type: 'Metal' }, 
            { label: 'E',  wl: 527, el: 'Fe',    color: '#33ff00', type: 'Metal' }, 
            { label: 'B',  wl: 687, el: 'O2',    color: '#cc0000', type: 'Metal' }, // Earth's Atmosphere
        ];

        const stars = {
            sun: { 
                name: "The Sun", color: "bg-yellow-400 shadow-[0_0_50px_orange]", 
                desc: "Balanced. Moderate Hydrogen. Strong Calcium, Iron, Sodium.",
                // Visibility: 0 = invisible, 1 = max darkness
                vis: { H: 0.7, He: 0.1, Na: 0.9, Metal: 0.8 } 
            },
            vega: { 
                name: "Vega", color: "bg-blue-300 shadow-[0_0_50px_cyan]", 
                desc: "Very Hot. Hydrogen is extremely dark/wide. Metals are weak (ionized).",
                vis: { H: 1.2, He: 0.3, Na: 0.1, Metal: 0.1 } 
            },
            betelgeuse: { 
                name: "Betelgeuse", color: "bg-red-600 shadow-[0_0_50px_red]", 
                desc: "Cool Giant. Weak Hydrogen. Very complex Metals and Molecules.",
                vis: { H: 0.2, He: 0.0, Na: 1.0, Metal: 1.5 } 
            }
        };

        let currentStar = 'sun';

        // --- Selectors ---
        const containers = {
            top: document.getElementById('solarSpectrum'),
            H: document.getElementById('hydrogenSpectrum'),
            He: document.getElementById('heliumSpectrum'),
            Na: document.getElementById('sodiumSpectrum'),
            Metal: document.getElementById('metalSpectrum')
        };

        // --- Logic ---
        function getPos(nm) { return ((nm - MIN_WL) / (MAX_WL - MIN_WL)) * 100; }

        function drawSpectra() {
            // Clear all
            Object.values(containers).forEach(c => c.innerHTML = '');
            
            const config = stars[currentStar];

            spectralData.forEach(line => {
                const pct = getPos(line.wl);
                if(pct < 0 || pct > 100) return;

                // 1. Draw Top Absorption Line (Dark Line)
                let intensity = config.vis[line.type] || 0;
                
                if (intensity > 0.05) {
                    const div = document.createElement('div');
                    // Store Wavelength in dataset for precise linking later
                    div.dataset.wl = line.wl; 
                    div.className = 'absolute top-0 bottom-0 bg-black/90 z-20 group cursor-help';
                    div.style.left = `${pct}%`;
                    div.style.width = intensity > 1.0 ? '4px' : (intensity > 0.6 ? '2px' : '1px');
                    div.style.opacity = Math.min(intensity, 1);
                    
                    // Tooltip
                    div.innerHTML = `<div class="opacity-0 group-hover:opacity-100 absolute bottom-full mb-1 left-1/2 -translate-x-1/2 bg-slate-900 text-white text-[10px] px-2 py-1 rounded whitespace-nowrap border border-slate-600 pointer-events-none">${line.el} ${line.wl}nm</div>`;
                    containers.top.appendChild(div);
                }

                // 2. Draw Bottom Reference Line (Bright Line)
                // Select correct container
                let targetContainer = null;
                if(line.type === 'H') targetContainer = containers.H;
                else if(line.type === 'He') targetContainer = containers.He;
                else if(line.type === 'Na') targetContainer = containers.Na;
                else if(line.type === 'Metal') targetContainer = containers.Metal;

                if(targetContainer) {
                    const refDiv = document.createElement('div');
                    refDiv.dataset.wl = line.wl; // Store WL for linking
                    refDiv.className = 'absolute top-0 bottom-0 w-[2px] emission-line cursor-pointer';
                    refDiv.style.left = `${pct}%`;
                    refDiv.style.backgroundColor = line.color;
                    refDiv.style.color = line.color; // for shadow
                    
                    // Click Tooltip
                    refDiv.onclick = (e) => {
                        e.stopPropagation();
                        document.querySelectorAll('.click-tooltip').forEach(el => el.remove());
                        const tip = document.createElement('div');
                        tip.className = 'click-tooltip absolute bottom-full mb-1 left-1/2 -translate-x-1/2 bg-white text-slate-900 text-xs px-2 py-1 rounded font-bold shadow z-50 whitespace-nowrap';
                        tip.innerText = `${line.el} (${line.wl} nm)`;
                        refDiv.appendChild(tip);
                        setTimeout(() => tip.remove(), 2500);
                    };

                    targetContainer.appendChild(refDiv);
                }
            });

            if(document.getElementById('matchToggle').checked) {
                // slight delay to ensure DOM paint
                requestAnimationFrame(drawConnections);
            }
        }

        // --- The Fixed Connection Logic ---
        function drawConnections() {
            const canvas = document.getElementById('connectionCanvas');
            const ctx = canvas.getContext('2d');
            const parent = document.getElementById('mainSpectrumContainer');
            
            // Resize canvas to match parent exactly
            if(canvas.width !== parent.offsetWidth || canvas.height !== parent.offsetHeight) {
                canvas.width = parent.offsetWidth;
                canvas.height = parent.offsetHeight;
            }
            ctx.clearRect(0,0, canvas.width, canvas.height);

            // Style
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.4)'; // Slightly brighter
            ctx.lineWidth = 1.5;
            ctx.setLineDash([4, 4]);

            // Get parent offset for relative calculation
            const parentRect = parent.getBoundingClientRect();

            spectralData.forEach(line => {
                // Find corresponding DOM elements by Data Attribute
                // This ensures we connect the EXACT visible lines, regardless of padding/margin
                const topEl = containers.top.querySelector(`[data-wl="${line.wl}"]`);
                
                // Find reference in any of the bottom containers
                let botEl = null;
                [containers.H, containers.He, containers.Na, containers.Metal].forEach(c => {
                    if(!botEl) botEl = c.querySelector(`[data-wl="${line.wl}"]`);
                });

                if (topEl && botEl) {
                    const topRect = topEl.getBoundingClientRect();
                    const botRect = botEl.getBoundingClientRect();

                    // Calculate Center X relative to the Canvas
                    // Now that widths are matched in CSS, x1 should equal x2 exactly.
                    const x1 = topRect.left + (topRect.width/2) - parentRect.left;
                    const y1 = topRect.bottom - parentRect.top;
                    
                    const x2 = botRect.left + (botRect.width/2) - parentRect.left;
                    const y2 = botRect.top - parentRect.top;

                    // Draw
                    ctx.beginPath();
                    ctx.moveTo(x1, y1);
                    ctx.lineTo(x2, y2);
                    ctx.stroke();
                }
            });
        }

        // --- Interaction ---
        function changeStar() {
            const val = document.getElementById('starSelector').value;
            currentStar = val;
            
            // Visual Updates
            document.getElementById('starDescription').innerText = stars[val].desc;
            const vis = document.getElementById('starVisual');
            vis.className = `w-20 h-20 rounded-full star-core transition-colors duration-1000 ${stars[val].color}`;

            drawSpectra();
        }

        function toggleMatchLines() {
            const on = document.getElementById('matchToggle').checked;
            const cvs = document.getElementById('connectionCanvas');
            cvs.style.opacity = on ? '1' : '0';
            if(on) drawConnections();
        }

        function toggleModal() {
            document.getElementById('infoModal').classList.toggle('hidden');
        }

        // Listeners
        // Use ResizeObserver for more robust handling of container size changes
        const resizeObserver = new ResizeObserver(() => {
            if(document.getElementById('matchToggle').checked) drawConnections();
        });
        resizeObserver.observe(document.getElementById('mainSpectrumContainer'));

        document.addEventListener('click', (e) => {
            if(!e.target.closest('.emission-line')) document.querySelectorAll('.click-tooltip').forEach(t => t.remove());
        });

        // Init
        drawSpectra();

    </script>
    
            <!-- Footer -->
    <footer style="text-align: center; padding: 1rem; color: #707070; font-size: 0.875rem;">
        <p style="font-style: italic; margin-bottom: 0.25rem;">But God made the earth by his power; he founded the world by his wisdom and stretched out the heavens by his understanding. Jeremiah 10:12</p>
        <p style="font-size: 0.75rem; margin-bottom: 0.25rem; margin-top: 0.5rem;">「耶和華用能力創造大地，用智慧建立世界，用聰明鋪張穹蒼。」 耶利米書 10:12</p>
        <p style="font-size: 0.75rem; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #d1d5db;">@ 2025 Generated by Gemini Pro 3.0  Prepared by SF Lau</p>
    </footer>
</body>
</html>
    <footer class="bg-slate-900 text-slate-400 py-8 text-center">
        <div class="max-w-7xl mx-auto px-4">
            <p class="text-sm italic mb-2">But God made the earth by his power;<br>
            he founded the world by his wisdom<br>
            and stretched out the heavens by his understanding.</p>
            <p class="text-sm mb-2">Jeremiah 10:12</p>
            <p class="text-xs mb-2 mt-4">「耶和華用能力創造大地，用智慧建立世界，用聰明鋪張穹蒼。」</p>
            <p class="text-xs mb-4">耶利米書 10:12</p>
            <p class="text-xs mt-4 pt-4 border-t border-slate-700">@ 2025 Generated by Gemini Pro 3.0  Prepared by SF Lau</p>
        </div>
    </footer>
</body>
</html>
    <footer class="bg-slate-900 text-slate-400 py-8 text-center">
        <div class="max-w-7xl mx-auto px-4">
            <p class="text-sm italic mb-2">But God made the earth by his power;<br>
            he founded the world by his wisdom<br>
            and stretched out the heavens by his understanding.</p>
            <p class="text-sm mb-2">Jeremiah 10:12</p>
            <p class="text-xs mb-2 mt-4">「耶和華用能力創造大地，用智慧建立世界，用聰明鋪張穹蒼。」</p>
            <p class="text-xs mb-4">耶利米書 10:12</p>
            <p class="text-xs mt-4 pt-4 border-t border-slate-700">@ 2025 Generated by Gemini Pro 3.0  Prepared by SF Lau</p>
        </div>
    </footer>
</body>
</html>
    <footer class="bg-slate-900 text-slate-400 py-8 text-center">
        <div class="max-w-7xl mx-auto px-4">
            <p class="text-sm italic mb-2">But God made the earth by his power;<br>
            he founded the world by his wisdom<br>
            and stretched out the heavens by his understanding.</p>
            <p class="text-sm mb-2">Jeremiah 10:12</p>
            <p class="text-xs mb-2 mt-4">「耶和華用能力創造大地，用智慧建立世界，用聰明鋪張穹蒼。」</p>
            <p class="text-xs mb-4">耶利米書 10:12</p>
            <p class="text-xs mt-4 pt-4 border-t border-slate-700">@ 2025 Generated by Gemini Pro 3.0  Prepared by SF Lau</p>
        </div>
    </footer>
</body>
</html>
    <footer class="bg-slate-900 text-slate-400 py-8 text-center">
        <div class="max-w-7xl mx-auto px-4">
            <p class="text-sm italic mb-2">But God made the earth by his power;<br>
            he founded the world by his wisdom<br>
            and stretched out the heavens by his understanding.</p>
            <p class="text-sm mb-2">Jeremiah 10:12</p>
            <p class="text-xs mb-2 mt-4">「耶和華用能力創造大地，用智慧建立世界，用聰明鋪張穹蒼。」</p>
            <p class="text-xs mb-4">耶利米書 10:12</p>
            <p class="text-xs mt-4 pt-4 border-t border-slate-700">@ 2025 Generated by Gemini Pro 3.0  Prepared by SF Lau</p>
        </div>
    </footer>
</body>
</html>