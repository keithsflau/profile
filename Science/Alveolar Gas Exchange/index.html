<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Alveolar Gas Exchange Simulator</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü´Å</text></svg>">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for in-browser compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      body { 
        font-family: 'Inter', sans-serif; 
        margin: 0;
        padding: 0;
        overflow: hidden;
      }
      #root {
        width: 100vw;
        height: 100vh;
      }
    </style>
  </head>
  <body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
      // --- GLOBALS & UTILS ---
      const { useState, useEffect, useRef } = React;
      const { createRoot } = ReactDOM;

      // --- ICON COMPONENTS (Inline SVGs for lucide-react) ---
      const Play = ({ size = 24, className = "" }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
          <polygon points="5 3 19 12 5 21 5 3"></polygon>
        </svg>
      );
      
      const Pause = ({ size = 24, className = "" }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
          <rect x="6" y="4" width="4" height="16"></rect>
          <rect x="14" y="4" width="4" height="16"></rect>
        </svg>
      );
      
      const Info = ({ size = 24, className = "" }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="16" x2="12" y2="12"></line>
          <line x1="12" y1="8" x2="12.01" y2="8"></line>
        </svg>
      );
      
      const Wind = ({ size = 24, className = "" }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
          <path d="M17.7 7.7a2.5 2.5 0 1 1 1.8 4.3H2"></path>
          <path d="M9.6 4.6A2 2 0 1 1 11 8H2"></path>
          <path d="M12.6 19.4A2 2 0 1 0 14 16H2"></path>
        </svg>
      );
      
      const Activity = ({ size = 24, className = "" }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
          <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
        </svg>
      );
      
      const Droplets = ({ size = 24, className = "" }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
          <path d="M7 16.3c2.2 0 4-1.8 4-4V5c0-2.2-1.8-4-4-4S3 2.8 3 5v7.3c0 2.2 1.8 4 4 4z"></path>
          <path d="M12.3 21.3c2.2 0 4-1.8 4-4V10c0-2.2-1.8-4-4-4s-4 1.8-4 4v7.3c0 2.2 1.8 4 4 4z"></path>
          <path d="M17.6 16.3c2.2 0 4-1.8 4-4V5c0-2.2-1.8-4-4-4s-4 1.8-4 4v7.3c0 2.2 1.8 4 4 4z"></path>
        </svg>
      );

      /**
       * Alveolar Gas Exchange Simulator
       * Optimized: Fixed IndexSizeError (negative radius) and React child errors.
       */
      const AlveoliSim = () => {
        // --- State & Configuration ---
        const [isPlaying, setIsPlaying] = useState(true);
        const [respirationRate, setRespirationRate] = useState(50);
        const [oxygenConc, setOxygenConc] = useState(80);
        const [bloodSpeed, setBloodSpeed] = useState(50);
        const [showTooltip, setShowTooltip] = useState(true);

        // Canvas Refs
        const canvasRef = useRef(null);
        const animationRef = useRef(null);
        
        // Use a ref to store current parameters to avoid resetting animation on state change
        const paramsRef = useRef({
          respirationRate,
          oxygenConc,
          bloodSpeed
        });

        // Sync state to ref
        useEffect(() => {
          paramsRef.current = { respirationRate, oxygenConc, bloodSpeed };
        }, [respirationRate, oxygenConc, bloodSpeed]);
        
        // Simulation State
        const gameState = useRef({
          particles: [], 
          rbcs: [],      
          breathPhase: 0,
          lastFrameTime: 0,
          initialized: false,
        });

        // --- Constants ---
        const COLORS = {
          background: '#f8fafc', 
          alveolusFill: '#ffe4e6', 
          alveolusStroke: '#fda4af', 
          capillaryFill: '#fef2f2', 
          capillaryStroke: '#ef4444', 
          o2: '#3b82f6', 
          co2: '#64748b', 
          bloodDeoxy: { r: 71, g: 85, b: 105 }, 
          bloodOxy: { r: 239, g: 68, b: 68 },   
        };

        // --- Helper Functions ---
        const lerpColor = (start, end, t) => {
          const r = Math.round(start.r + (end.r - start.r) * t);
          const g = Math.round(start.g + (end.g - start.g) * t);
          const b = Math.round(start.b + (end.b - start.b) * t);
          return `rgb(${r},${g},${b})`;
        };

        // --- Animation Loop ---
        useEffect(() => {
          const canvas = canvasRef.current;
          if (!canvas) return;
          
          const ctx = canvas.getContext('2d');
          let width = 0;
          let height = 0;

          // Responsive Canvas with proper aspect ratio handling
          const handleResize = () => {
            if (canvas.parentElement) {
              const dpr = window.devicePixelRatio || 1;
              const clientWidth = canvas.parentElement.clientWidth;
              const clientHeight = canvas.parentElement.clientHeight;
              
              // Prevent 0 size which causes calculation errors
              if (clientWidth === 0 || clientHeight === 0) {
                // Retry after a short delay
                setTimeout(handleResize, 100);
                return;
              }

              // Set canvas size with device pixel ratio for crisp rendering
              canvas.width = clientWidth * dpr;
              canvas.height = clientHeight * dpr;
              
              // Scale context to match device pixel ratio
              ctx.scale(dpr, dpr);
              
              // Store logical dimensions
              width = clientWidth;
              height = clientHeight;
              
              // Re-initialize if needed
              if (!gameState.current.initialized && width > 0 && height > 0) {
                gameState.current.rbcs = [];
                gameState.current.particles = [];
                const startY = height - 60;
                for(let i=0; i<8; i++) {
                  gameState.current.rbcs.push({
                    x: -50 - (i * 120), 
                    y: startY,     
                    saturation: 0,      
                    id: Math.random()
                  });
                }
                gameState.current.initialized = true;
              }
            }
          };
          
          window.addEventListener('resize', handleResize);
          handleResize();

          const render = (time) => {
            // Safety check: Don't render if dimensions are invalid
            if (width <= 0 || height <= 0) {
              animationRef.current = requestAnimationFrame(render);
              return;
            }

            if (!isPlaying) {
              gameState.current.lastFrameTime = time;
              animationRef.current = requestAnimationFrame(render);
              return;
            }

            const deltaTime = Math.min(time - gameState.current.lastFrameTime, 100); // Cap deltaTime to prevent large jumps
            gameState.current.lastFrameTime = time;

            const { respirationRate, oxygenConc, bloodSpeed } = paramsRef.current;

            // 1. Clear Canvas
            ctx.clearRect(0, 0, width, height);
            ctx.fillStyle = COLORS.background;
            ctx.fillRect(0, 0, width, height);

            // --- Physics Constants ---
            const flowSpeedFactor = 0.5 + (bloodSpeed / 100) * 2.0; 
            const breathSpeed = 0.002 + (respirationRate / 100) * 0.008; 
            const o2SpawnRate = (oxygenConc / 100) * 0.4; 

            // --- Update Breath State ---
            gameState.current.breathPhase += breathSpeed * deltaTime;
            const lungExpansion = Math.sin(gameState.current.breathPhase) * 10; 

            // --- Draw Anatomy ---
            const cx = width / 2;
            const cy = Math.max(height / 2 - 50, 100); // Ensure minimum Y position
            
            // FIX: Ensure radius is never negative and proportional to screen size
            const baseRadius = Math.min(width, height) * 0.35;
            const radius = Math.max(30, baseRadius + lungExpansion);

            // Alveolus
            ctx.beginPath();
            ctx.arc(cx, cy, radius, 0, Math.PI * 2);
            ctx.fillStyle = COLORS.alveolusFill;
            ctx.fill();
            ctx.lineWidth = 4;
            ctx.strokeStyle = COLORS.alveolusStroke;
            ctx.stroke();

            // Capillary
            const capY = cy + radius + 15;
            const capHeight = 60;
            
            ctx.beginPath();
            ctx.moveTo(0, capY - 20);
            ctx.quadraticCurveTo(cx, capY - 60, width, capY - 20);
            ctx.lineTo(width, capY + capHeight);
            ctx.quadraticCurveTo(cx, capY + capHeight - 40, 0, capY + capHeight);
            ctx.closePath();
            ctx.fillStyle = COLORS.capillaryFill;
            ctx.fill();
            ctx.strokeStyle = COLORS.capillaryStroke;
            ctx.lineWidth = 2;
            ctx.stroke();

            // --- Particles ---

            // 1. RBCs
            const lastRbc = gameState.current.rbcs[gameState.current.rbcs.length - 1];
            if (!lastRbc || lastRbc.x > -50) {
              gameState.current.rbcs.push({
                x: -120, 
                y: 0,
                saturation: 0,
                id: Math.random()
              });
            }

            gameState.current.rbcs.forEach((rbc) => {
              rbc.x += 2 * flowSpeedFactor * (deltaTime / 16); // Normalize by frame time

              const nx = (rbc.x - width/2) / (width/2);
              const curveDip = 40 * (1 - nx*nx); 
              rbc.y = capY + 20 - curveDip; 
              
              if (rbc.x > width * 0.2 && rbc.x < width * 0.8) {
                  rbc.saturation += 0.005 * (oxygenConc / 50) * (deltaTime / 16);
                  if (rbc.saturation > 1) rbc.saturation = 1;
              }

              ctx.beginPath();
              ctx.ellipse(rbc.x, rbc.y, 20, 15, rbc.x/100, 0, Math.PI * 2);
              ctx.fillStyle = lerpColor(COLORS.bloodDeoxy, COLORS.bloodOxy, rbc.saturation);
              ctx.fill();
              ctx.strokeStyle = "rgba(0,0,0,0.1)";
              ctx.stroke();

              ctx.beginPath();
              ctx.ellipse(rbc.x, rbc.y, 10, 7, rbc.x/100, 0, Math.PI * 2);
              ctx.fillStyle = "rgba(0,0,0,0.1)";
              ctx.fill();
            });

            gameState.current.rbcs = gameState.current.rbcs.filter(rbc => rbc.x < width + 100);

            // 2. Gas Particles
            if (Math.random() < o2SpawnRate) {
              const angle = Math.random() * Math.PI * 2;
              const r = Math.random() * Math.max(10, radius - 20); 
              gameState.current.particles.push({
                type: 'O2',
                x: cx + Math.cos(angle) * r,
                y: cy + Math.sin(angle) * r,
                vx: (Math.random() - 0.5) * 0.5,
                vy: Math.random() * 0.5 + 0.2, 
                life: 1.0
              });
            }

            gameState.current.rbcs.forEach(rbc => {
               if (rbc.x > width * 0.2 && rbc.x < width * 0.8 && rbc.saturation < 0.8) {
                  if (Math.random() < 0.05) {
                      gameState.current.particles.push({
                          type: 'CO2',
                          x: rbc.x + (Math.random()-0.5)*20,
                          y: rbc.y - 15, 
                          vx: (Math.random() - 0.5) * 0.5,
                          vy: -1 * (Math.random() * 0.5 + 0.5), 
                          life: 1.0
                      });
                  }
               }
            });

            gameState.current.particles.forEach((p) => {
              p.x += p.vx * (deltaTime / 16);
              p.y += p.vy * (deltaTime / 16);
              p.life -= 0.005 * (deltaTime / 16); 
              p.x += (Math.random() - 0.5) * 1;
              p.y += (Math.random() - 0.5) * 1;

              if (p.type === 'O2') {
                  if (p.y > capY - 20) p.life -= 0.05; 
              } else {
                  if (p.y < cy) p.life -= 0.01; 
              }

              ctx.globalAlpha = Math.max(0, p.life);
              ctx.fillStyle = p.type === 'O2' ? COLORS.o2 : COLORS.co2;
              ctx.beginPath();
              ctx.arc(p.x, p.y, p.type === 'O2' ? 3 : 4, 0, Math.PI * 2);
              ctx.fill();
              ctx.globalAlpha = 1.0;
            });

            gameState.current.particles = gameState.current.particles.filter(p => p.life > 0);

            // Labels inside Canvas
            ctx.font = "bold 16px Inter, sans-serif";
            ctx.fillStyle = "#64748b";
            ctx.textAlign = "center";
            ctx.fillText("Alveolus (Air Sac)", cx, cy);
            
            ctx.fillStyle = COLORS.capillaryStroke;
            ctx.fillText("Pulmonary Capillary", width - 100, capY + 50);

            animationRef.current = requestAnimationFrame(render);
          };

          render(performance.now());

          return () => {
            if (animationRef.current) {
              cancelAnimationFrame(animationRef.current);
            }
            window.removeEventListener('resize', handleResize);
          };
        }, [isPlaying]);


        return (
          <div className="flex flex-col md:flex-row h-screen w-full bg-slate-50 font-sans text-slate-800 overflow-hidden">
            
            {/* LEFT: Simulation Canvas */}
            <div className="relative flex-grow h-[60vh] md:h-full bg-white shadow-inner" style={{ minHeight: '400px' }}>
              <canvas 
                ref={canvasRef} 
                className="w-full h-full block"
                style={{ display: 'block' }}
              />
              
              {/* Floating Legend */}
              <div className="absolute top-4 left-4 bg-white/90 backdrop-blur p-4 rounded-lg shadow border border-slate-200 text-sm pointer-events-none">
                <h3 className="font-bold mb-3 text-slate-600 tracking-wider">Legend</h3>
                <div className="flex items-center gap-3 mb-2">
                  <div className="w-3 h-3 rounded-full bg-blue-500 shadow-sm"></div>
                  <span>Oxygen (O<sub>2</sub>)</span>
                </div>
                <div className="flex items-center gap-3 mb-2">
                  <div className="w-3 h-3 rounded-full bg-slate-500 shadow-sm"></div>
                  <span>Carbon Dioxide (CO<sub>2</sub>)</span>
                </div>
                <div className="flex items-center gap-3">
                  <div className="w-8 h-3 rounded-full bg-gradient-to-r from-slate-600 to-red-500 shadow-sm"></div>
                  <span>RBC Oxygenation</span>
                </div>
              </div>

              {/* Info Tooltip Overlay */}
              {showTooltip && (
                <div className="absolute bottom-6 left-6 right-6 md:right-auto md:w-96 bg-blue-50/95 backdrop-blur border border-blue-100 p-5 rounded-xl shadow-lg">
                  <div className="flex justify-between items-start mb-3">
                    <h4 className="font-bold text-blue-900 flex items-center gap-2 text-lg">
                      <Info size={20} /> How it works
                    </h4>
                    <button 
                      onClick={() => setShowTooltip(false)} 
                      className="text-blue-400 hover:text-blue-600 text-xl font-bold cursor-pointer"
                      aria-label="Close"
                    >
                      √ó
                    </button>
                  </div>
                  <p className="text-sm text-blue-800 leading-relaxed mb-2">
                    <strong>Gas Exchange</strong> is driven by <em className="font-semibold">Partial Pressure Gradients</em>. 
                    Gases naturally move from areas of high concentration to low concentration.
                  </p>
                  <ul className="text-sm text-blue-700 space-y-1 list-disc pl-5">
                    <li><strong>O<sub>2</sub></strong>: Moves from Alveoli (High) ‚Üí Blood (Low)</li>
                    <li><strong>CO<sub>2</sub></strong>: Moves from Blood (High) ‚Üí Alveoli (Low)</li>
                  </ul>
                </div>
              )}
            </div>

            {/* RIGHT: Controls Dashboard */}
            <div className="w-full md:w-80 lg:w-96 bg-slate-50 border-l border-slate-200 p-6 flex flex-col gap-6 overflow-y-auto z-10 shadow-xl">
              
              <div className="mb-2">
                <h1 className="text-2xl font-bold text-slate-900">Alveolar Gas Exchange</h1>
                <p className="text-sm text-slate-500">Interactive Physiology Module</p>
              </div>

              {/* Playback Controls */}
              <div className="flex gap-2">
                  <button 
                      onClick={() => setIsPlaying(!isPlaying)}
                      className={`flex-1 flex items-center justify-center gap-2 py-2.5 rounded-lg font-medium transition-colors ${
                          isPlaying 
                          ? 'bg-amber-100 text-amber-700 hover:bg-amber-200' 
                          : 'bg-emerald-100 text-emerald-700 hover:bg-emerald-200'
                      }`}
                  >
                      {isPlaying ? (
                        <span className="flex items-center gap-2"><Pause size={18} /> Pause Simulation</span>
                      ) : (
                        <span className="flex items-center gap-2"><Play size={18} /> Resume</span>
                      )}
                  </button>
                  <button 
                      onClick={() => setShowTooltip(true)}
                      className="p-2 bg-white border border-slate-200 rounded-lg text-slate-400 hover:text-blue-500 hover:border-blue-200 transition-colors"
                      title="Show Info"
                  >
                      <Info size={24} />
                  </button>
              </div>

              <hr className="border-slate-200" />

              {/* Control 1: Respiration Rate */}
              <div className="space-y-3">
                <div className="flex justify-between items-center">
                  <label className="flex items-center gap-2 font-semibold text-slate-700">
                    <Wind size={20} className="text-sky-500" /> Respiration Rate
                  </label>
                  <span className="text-xs font-mono bg-slate-200 px-2 py-1 rounded text-slate-600">
                    {Math.round(12 + (respirationRate/100)*20)} bpm
                  </span>
                </div>
                <input 
                  type="range" 
                  min="0" max="100" 
                  value={respirationRate}
                  onChange={(e) => setRespirationRate(parseInt(e.target.value))}
                  className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-sky-500"
                />
                <p className="text-xs text-slate-500 leading-relaxed">
                  Controls how often fresh air enters the alveolus, maintaining the O<sub>2</sub> gradient.
                </p>
              </div>

              {/* Control 2: Oxygen Concentration */}
              <div className="space-y-3">
                <div className="flex justify-between items-center">
                  <label className="flex items-center gap-2 font-semibold text-slate-700">
                    <Droplets size={20} className="text-blue-500" /> Alveolar P<sub>O2</sub>
                  </label>
                  <span className="text-xs font-mono bg-slate-200 px-2 py-1 rounded text-slate-600">
                    {Math.round(40 + (oxygenConc/100)*60)} mmHg
                  </span>
                </div>
                <input 
                  type="range" 
                  min="0" max="100" 
                  value={oxygenConc}
                  onChange={(e) => setOxygenConc(parseInt(e.target.value))}
                  className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-500"
                />
                <p className="text-xs text-slate-500 leading-relaxed">
                  Represents the partial pressure of oxygen. Higher pressure pushes more O<sub>2</sub> into the blood.
                </p>
              </div>

              {/* Control 3: Blood Flow Speed */}
              <div className="space-y-3">
                <div className="flex justify-between items-center">
                  <label className="flex items-center gap-2 font-semibold text-slate-700">
                    <Activity size={20} className="text-red-500" /> Cardiac Output
                  </label>
                  <span className="text-xs font-mono bg-slate-200 px-2 py-1 rounded text-slate-600">
                    {(0.5 + (bloodSpeed/100)*4.5).toFixed(1)} L/min
                  </span>
                </div>
                <input 
                  type="range" 
                  min="1" max="100" 
                  value={bloodSpeed}
                  onChange={(e) => setBloodSpeed(parseInt(e.target.value))}
                  className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-red-500"
                />
                <p className="text-xs text-slate-500 leading-relaxed">
                  Speed of blood flow through the capillary. Too fast, and RBCs might not fully oxygenate!
                </p>
              </div>

              <div className="mt-auto pt-6 text-center text-xs text-slate-400">
                Visualizing Fick's Law of Diffusion
              </div>

            </div>
          </div>
        );
      };

      const root = createRoot(document.getElementById('root'));
      root.render(<AlveoliSim />);
    </script>
  </body>
</html>
